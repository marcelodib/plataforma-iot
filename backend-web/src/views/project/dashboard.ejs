<%include ../common/header.ejs%>

<link rel="stylesheet" type="text/css" href="css/customForm.css">

<!-- CONTENT -->
<div class="container">

    <br><br>

    <div class="divCenterForm">
        <h3 id="pageTitle">Dashboard &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</h3>
        <br>
        <form class="form-inline" action="javascript:createProject()" method="POST">
        
            <!-- input  -->
            <div class="form-group mb-2">
                <label> Data de Inicio&nbsp;&nbsp;</label>
                <input type="date" name="startDate" id="startDate" class="form-control" required>
            </div>

            <!-- input  -->
            <div class="form-group mb-2 mx-sm-3">
                <label> Data de Fim&nbsp;&nbsp;</label>
                <input type="date" name="endDate" id="endDate" class="form-control" required>
            </div>

            <button class="btn btn-primary btnLeft mb-2" type="submit" style="height: 50%;">Buscar</button>
            <button class="btn btn-warning text-white mb-2 mx-sm-3" type="button">Live</button>
        </form>

        <br>
        <br>
        <br>

        <h3 class="text-secondary">Últimas medidas</h3>
        <hr>

        <div class="row" id="rowCards"></div>

        <h3 class="text-secondary">Gráficos</h3>
        <hr>
        <div id="rowCharts"></div>

        <h3 class="text-secondary">Tabelas</h3>
        <hr>
        <div class="row" id="rowTables"></div>
        <hr>
    </div>

    <br><br>

</div>
<!-- /CONTENT -->

<%include ../common/footer.ejs%>

<script defer src="js/amcharts/core.js"></script>

<script defer src="js/amcharts/charts.js"></script>

<script defer src="js/amcharts/themes/kelly.js"></script>

<script defer src="js/amcharts/themes/animated.js"></script>


<script>
    let idProject = 0;
/*============================================================================*/
    /**
     * =======================================================
     * |Função responsável executar todas as rotinas iniciais|
     * |da página assim que ela é carregada.                 |
     * =======================================================
     */
    window.onload = () => { 
        const urlParams = new URLSearchParams(window.location.search);
        const projectName = urlParams.get('projectName');
        idProject = urlParams.get('idProject');

        document.getElementById("pageTitle").innerHTML = projectName;
        /*Chamada da função que adiciona o titulo da side bar.*/
        setSideBarTitle("Dashboard", "fa-chart-line");

        am4core.ready(() => {
            listVariable(idProject);
        });
    };
    $(document).ready(function () {
        /*Chamada da função que ativa a side bar.*/
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar').toggleClass('active');
        });
    });
/*============================================================================*/

/*============================================================================*/
    /**
     * ========================================================
     * |Função responsável por buscar todas as variáveis do   |
     * |projeto selecionado.                                  |
     * ========================================================
     */
    function listVariable (idProject) {
        /*Varificação se o idProject enviado é válido.*/
        if (isNaN(idProject) || idProject === 0) {
            return alert("Identificador do projeto inválido!")
        }

        /*Chamada axios para a rota listProjectVariables para buscar as variáveis do projeto selecionado.*/
        axios.post("/listVariable", {idProject: idProject})
        .then((response) => {
            /* Tratamento do retorno.*/
            if (response.status === 200 && response.data.status === "success") {
                /*Atribuição das variáveis enviadas.*/
                const variables = response.data.data;
                /*Variáveis de manipulação da lista de variáveis/*/
                const rowCards  = document.getElementById("rowCards");
                const rowCharts = document.getElementById("rowCharts");
                const rowTables = document.getElementById("rowTables");

                /*Variável auxiliar para guardar todos os charts que precisam ser criados.*/
                const auxCharts = [];

                /*Loop responsável por renderizar o modo de exibição de cada variável.*/
                variables.forEach(element => {
                    if (element.idExhibition === 1) {
                        rowCharts.innerHTML += templateChart(element, idProject);
                        auxCharts.push({name: element.variableName, id: `variable-${element.idVariable}`});
                    }
                    if (element.idExhibition === 2) {
                        rowTables.innerHTML += templateTable(element, idProject);
                    }
                    if (element.idExhibition === 3) {
                        rowCards.innerHTML += templateCard(element, idProject);
                    }
                });

                /*Loop responsável por renderizar as variáveis que utilizam gráfico.*/
                auxCharts.forEach(element => {
                    createChartTemp([], element.name, element.id);
                });
            }
        })
        .catch((error) => {
            /*Atribuição da mensagem de retorno do servidor.*/
            const errorMsg = error.response.data.msg;

            let msg = "";

            /*Verificação se foi enviada mais de uma mensagem.*/
            if(Array.isArray(errorMsg)) {
                /*Loop responsável por concatenar todas as mensagens enviadas.*/
                for (const i in errorMsg) {
                    msg += errorMsg[i].msg + "\n";
                }
            } 
            /*Alertar o usuario, caso tenha ocorrido algum erro no servidor*/
            alert(msg);
        });
    }
/*============================================================================*/

/*============================================================================*/
    /**
     * =======================================================
     * |Função responsável por retornar um template html de  |
     * |um card para exibição de dados de uma variável.      |
     * =======================================================
     */
    function templateCard(variable, idProject) {
        return `
            <div class="col">
                <div class="card">
                    <div class="card-body" style="width:15rem">
                        <h5 class="card-title text-secondary">${variable.variableName}</h5>
                        <h1 id="variable-${variable.idVariable}" class="text-secondary"></h1>
                    </div>
                </div>
            </div>
        `;
    }
/*============================================================================*/

/*============================================================================*/
    /**
     * =======================================================
     * |Função responsável por retornar um template html de  |
     * |um gráfico para exibição de dados de uma variável.   |
     * =======================================================
     */
    function templateChart(variable, idProject) {
        return `
            <div class="row">
                <div class="col-lg">
                    <div class="chartdiv" id="variable-${variable.idVariable}"></div>
                </div>
            </div>
            <br><br><br><br><br><br><br>
        `;
    }
/*============================================================================*/

/*============================================================================*/
    /**
     * =======================================================
     * |Função responsável por retornar um template html de  |
     * |uma tabela para exibição de dados de uma variável.   |
     * =======================================================
     */
    function templateTable(variable, idProject) {
        return `
            <div class="table col" style="height: 400px; min-width: 30%; overflow: scroll;">
                <h5 class="text-secondary" style="text-align: center;">${variable.variableName}</h5>
                <table class="table" id="variableTable">
                    <thead id="tableHeader">
                        <th>ID</th>
                        <th>Valor</th>
                        <th>Data/Hora</th>
                    </thead>
                    <tbody id="variable-${variable.idVariable}">
                    </tbody>
                </table>
            </div>
        `;
    }
/*============================================================================*/

/*============================================================================*/
    /**
     * =======================================================
     * |Função responsável por retornar um template html de  |
     * |um determinado item da tabela, correspondente a uma  |
     * |medida.                                              |
     * =======================================================
     */
    function templateListMeasure(measure) {
        return `
            <td>${measure.idVariable}</td>
            <td>${measure.value}</td>
            <td>${measure.dateTime}</td>
        `;
    }
/*============================================================================*/

/*============================================================================*/
    function createChartTemp(measure, chartTitle, idDiv) {
        // Themes begin
        am4core.useTheme(am4themes_animated);
        // Themes end

        // Create chart instance
        let chart = am4core.create(idDiv, am4charts.XYChart);

        chart.data = measure;

        // Create axes
        let dateAxis = chart.xAxes.push(new am4charts.DateAxis());
        let valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

        let title = chart.titles.create();
        title.text = chartTitle;
        title.fontSize = 20;
        title.marginBottom = 5;

        dateAxis.baseInterval = {
            timeUnit: "minute",
            count: 1
        };

        dateAxis.tooltipDateFormat = "HH:mm, d MMMM";

        // Create series
        let series = chart.series.push(new am4charts.LineSeries());
        series.dataFields.valueY = "value";
        series.dataFields.dateX = "date";
        series.tooltipText = "{value}"
        series.strokeWidth = 2;
        series.minBulletDistance = 15;

        // Drop-shaped tooltips
        series.tooltip.background.cornerRadius = 20;
        series.tooltip.background.strokeOpacity = 0;
        series.tooltip.pointerOrientation = "vertical";
        series.tooltip.label.minWidth = 40;
        series.tooltip.label.minHeight = 40;
        series.tooltip.label.textAlign = "middle";
        series.tooltip.label.textValign = "middle";

        // Make bullets grow on hover
        let bullet = series.bullets.push(new am4charts.CircleBullet());
        bullet.circle.strokeWidth = 2;
        bullet.circle.radius = 4;
        bullet.circle.fill = am4core.color("#fff");

        let bullethover = bullet.states.create("hover");
        bullethover.properties.scale = 1.3;

        //Make a panning cursor
        chart.cursor = new am4charts.XYCursor();
        chart.cursor.behavior = "panXY";
        chart.cursor.xAxis = dateAxis;
        chart.cursor.snapToSeries = series;

        // Create a horizontal scrollbar with previe and place it underneath the date axis
        chart.scrollbarX = new am4charts.XYChartScrollbar();
        chart.scrollbarX.series.push(series);
        // chart.scrollbarX.parent = chart.bottomAxesContainer;

        dateAxis.start = 0.79;
        dateAxis.keepSelection = true;
    }
/*============================================================================*/

</script>

</html>